{% extends "base.html" %}

{% block title %} EVALUATION {% endblock title %}

{% block body %}
<div class="container mt-4">
    <h1>Keywords/Tokens Evaluation</h1>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Row#</th>
                <th>Text Preview</th>
                <th>Token Count</th>
                <th>Paragraphs</th>
            </tr>
        </thead>
        <tbody>
            {% for item in data %}
            <tr>
                <td>{{ item.row }}</td>
                <td>{{ item.text_preview[:20] }}...</td>
     <td>
    <a href="#" data-toggle="modal" data-target="#tokenCountModal"
       onclick='showTokens({{ item.tokens | tojson | safe }})'>{{ item.token_count }}</a>
</td>


                <td>
                    <a href="#" data-toggle="modal" data-target="#fullDocumentModal"
                       onclick="showFullDocument('{{ item.full_text }}')">{{ item.paragraph_count }}</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
       <!-- Loader Indicator -->
       <div id="loader" style="display: none; text-align: center; margin-top: 20px;">
        <div class="spinner-border" role="status">
        </div>
        <p>Loading, please wait...</p>
    </div>
</div>

    <button class="btn btn-info" data-toggle="modal" data-target="#uniqueTokensModal">
        Unique Tokens ({{ unique_tokens }})
    </button>
    <button class="btn btn-info" data-toggle="modal" data-target="#vectorDBModal">
        Vector DB Size
    </button>
    <button class="btn btn-info" data-toggle="modal" data-target="#sqlDBModal">
        SQL DB Size
    </button>
</div>

 

<!-- Token Count Modal -->
<div class="modal fade" id="tokenCountModal" tabindex="-1" role="dialog" aria-labelledby="tokenCountModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tokenCountModalLabel">Token Count</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: scroll;">
                <ul id="tokenList"></ul>
            </div>
        </div>
    </div>
</div>

<!-- Full Document Modal -->
<div class="modal fade" id="fullDocumentModal" tabindex="-1" role="dialog" aria-labelledby="fullDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fullDocumentModalLabel">Full Document</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="fullDocumentText" style="max-height: 400px; overflow-y: scroll;">
                <!-- Full text will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Unique Tokens Modal -->
<div class="modal fade" id="uniqueTokensModal" tabindex="-1" role="dialog" aria-labelledby="uniqueTokensModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uniqueTokensModalLabel">Unique Tokens</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: scroll;">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Token</th>
                            <th>Count</th>
                        </tr>
                    </thead>
                    <tbody id="uniqueTokensList">
                        <!-- Unique tokens will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Vector DB Size Modal -->
<div class="modal fade" id="vectorDBModal" tabindex="-1" role="dialog" aria-labelledby="vectorDBModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="vectorDBModalLabel">Vector DB Size</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Number of records: {{ vector_db_records }}</p>
                <p>Size on disk: {{ vector_db_size }}</p>
            </div>
        </div>
    </div>
</div>

<!-- SQL DB Size Modal -->
<div class="modal fade" id="sqlDBModal" tabindex="-1" role="dialog" aria-labelledby="sqlDBModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sqlDBModalLabel">SQL DB Size</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Record count: {{ sql_db_records }}</p>
                <p>Size: {{ sql_db_size }}</p>
            </div>
        </div>
    </div>
</div>



<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
function showTokens(tokens) {
    console.log(tokens); // Verify the input

    // Check if tokens is already an array
    let tokenList;
    if (typeof tokens === 'string') {
        try {
            tokenList = JSON.parse(tokens); // Try parsing if it's a JSON string
        } catch (error) {
            console.error("Failed to parse tokens:", error);
            return; // Exit the function if parsing fails
        }
    } else if (Array.isArray(tokens)) {
        tokenList = tokens; // Use directly if it's already an array
    } else {
        console.error("Invalid tokens format");
        return;
    }

    // If tokenList is correctly parsed or provided
    const tokenListContainer = document.getElementById('tokenList');
    tokenListContainer.innerHTML = ""; // Clear previous data

    tokenList.sort(); // Sort tokens alphabetically

    tokenList.forEach(token => {
        const li = document.createElement('li');
        li.textContent = token;
        tokenListContainer.appendChild(li);
    });
}

    function showFullDocument(fullText) {
        document.getElementById('fullDocumentText').textContent = fullText;
    }

    document.addEventListener("DOMContentLoaded", function() {
    // Fetch and display unique tokens when Unique Tokens button is clicked
    document.querySelector('[data-target="#uniqueTokensModal"]').addEventListener("click", function() {
        // Show loader
        document.getElementById('loader').style.display = 'block';

        fetch('/token_occurrences/') // Update the endpoint to the correct API URL
            .then(response => response.json())
            .then(data => {
                const uniqueTokensList = document.getElementById('uniqueTokensList');
                uniqueTokensList.innerHTML = ""; // Clear previous data

                // Loop through the data directly as itâ€™s already in the required format
                data.forEach(token => { // Directly use the token data array
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${token.token}</td><td>${token.count}</td>`; // Adjusted to match the JSON structure
                    uniqueTokensList.appendChild(row);
                });
            })
            .catch(error => console.error('Error fetching unique tokens:', error))
            .finally(() => {
                // Hide loader
                document.getElementById('loader').style.display = 'none';
            });
    });

    // Fetch and display vector DB details when Vector DB button is clicked
    document.querySelector('[data-target="#vectorDBModal"]').addEventListener("click", function() {
        // Show loader
        document.getElementById('loader').style.display = 'block';

        fetch('/vector-db-details/')
            .then(response => response.json())
            .then(data => {
                document.querySelector('#vectorDBModal .modal-body').innerHTML = `
                    <p>Number of records: ${data.record_count}</p>
                    <p>Size on disk: ${data.db_size}</p>
                `;
            })
            .catch(error => console.error('Error fetching vector DB details:', error))
            .finally(() => {
                // Hide loader
                document.getElementById('loader').style.display = 'none';
            });
    });

    // Fetch and display SQL DB details when SQL DB button is clicked
    document.querySelector('[data-target="#sqlDBModal"]').addEventListener("click", function() {
        // Show loader
        document.getElementById('loader').style.display = 'block';

        fetch('/sql/')
            .then(response => response.json())
            .then(data => {
                document.querySelector('#sqlDBModal .modal-body').innerHTML = `
                    <p>Record count: ${data.record_count}</p>
                    <p>Size: ${data.size}</p>
                `;
            })
            .catch(error => console.error('Error fetching SQL DB details:', error))
            .finally(() => {
                // Hide loader
                document.getElementById('loader').style.display = 'none';
            });
    });
});
</script>

{% endblock %}
